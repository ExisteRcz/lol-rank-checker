<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoL Rank Checker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <!-- Rune Popup -->
    <div class="rune-popup-overlay" id="runePopup" onclick="closeRunePopup(event)">
        <div class="rune-popup" onclick="event.stopPropagation()">
            <div class="rune-popup-header">
                <span class="rune-popup-title">Runes</span>
                <button class="rune-popup-close" onclick="closeRunePopup()">&times;</button>
            </div>
            <div id="runePopupContent"></div>
        </div>
    </div>

    <div class="container">
        <h1>LoL Rank Checker</h1>
        <p class="subtitle">Check any player's ranked stats, top champions, and side winrates</p>

        <div class="search-box">
            <div class="input-row">
                <div class="input-group">
                    <label>Game Name</label>
                    <input type="text" id="gameName" placeholder="ExisteRcz" value="{{ prefill_name or '' }}">
                </div>
                <div class="input-group">
                    <label>Tag</label>
                    <input type="text" id="tagLine" placeholder="EUNE" value="{{ prefill_tag or '' }}">
                </div>
                <div class="input-group">
                    <label>Region</label>
                    <select id="region">
                        <option value="eun1" {{ 'selected' if prefill_region == 'eun1' else '' }}>EUNE</option>
                        <option value="euw1" {{ 'selected' if prefill_region == 'euw1' else '' }}>EUW</option>
                        <option value="na1" {{ 'selected' if prefill_region == 'na1' else '' }}>NA</option>
                        <option value="kr" {{ 'selected' if prefill_region == 'kr' else '' }}>Korea</option>
                        <option value="br1" {{ 'selected' if prefill_region == 'br1' else '' }}>Brazil</option>
                        <option value="tr1" {{ 'selected' if prefill_region == 'tr1' else '' }}>Turkey</option>
                        <option value="ru" {{ 'selected' if prefill_region == 'ru' else '' }}>Russia</option>
                    </select>
                </div>
            </div>
            <button class="search-btn" id="searchBtn" onclick="lookup(false)">Search</button>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p id="loadingText">Fetching player data and analyzing matches...</p>
        </div>

        <div id="results" class="results"></div>
    </div>

    <script>
        const DDRAGON_BASE = 'https://ddragon.leagueoflegends.com/cdn';
        const RANK_EMBLEMS = 'https://raw.communitydragon.org/latest/plugins/rcp-fe-lol-static-assets/global/default/images';

        let currentPlayerData = null;
        let matchesDisplayed = 5;
        let matchRunesData = [];

        function getRankEmblem(tier) {
            const t = tier.toLowerCase();
            return `${RANK_EMBLEMS}/ranked-mini-crests/${t}.svg`;
        }

        function getProfileIcon(iconId, version) {
            return `${DDRAGON_BASE}/${version}/img/profileicon/${iconId}.png`;
        }

        function getChampionIcon(champId, version) {
            return `${DDRAGON_BASE}/${version}/img/champion/${champId}.png`;
        }

        function getItemIcon(itemId, version) {
            if (!itemId || itemId === 0) return null;
            return `${DDRAGON_BASE}/${version}/img/item/${itemId}.png`;
        }

        // Rune tree data
        const RUNE_TREES = {
            8000: { name: 'Precision', icon: 'perk-images/Styles/7201_Precision.png' },
            8100: { name: 'Domination', icon: 'perk-images/Styles/7200_Domination.png' },
            8200: { name: 'Sorcery', icon: 'perk-images/Styles/7202_Sorcery.png' },
            8300: { name: 'Inspiration', icon: 'perk-images/Styles/7203_Whimsy.png' },
            8400: { name: 'Resolve', icon: 'perk-images/Styles/7204_Resolve.png' }
        };

        // Individual rune data
        const RUNES = {
            // Precision
            8005: { name: 'Press the Attack', icon: 'perk-images/Styles/Precision/PressTheAttack/PressTheAttack.png' },
            8008: { name: 'Lethal Tempo', icon: 'perk-images/Styles/Precision/LethalTempo/LethalTempoTemp.png' },
            8021: { name: 'Fleet Footwork', icon: 'perk-images/Styles/Precision/FleetFootwork/FleetFootwork.png' },
            8010: { name: 'Conqueror', icon: 'perk-images/Styles/Precision/Conqueror/Conqueror.png' },
            9101: { name: 'Overheal', icon: 'perk-images/Styles/Precision/Overheal.png' },
            9111: { name: 'Triumph', icon: 'perk-images/Styles/Precision/Triumph.png' },
            8009: { name: 'Presence of Mind', icon: 'perk-images/Styles/Precision/PresenceOfMind/PresenceOfMind.png' },
            9104: { name: 'Legend: Alacrity', icon: 'perk-images/Styles/Precision/LegendAlacrity/LegendAlacrity.png' },
            9105: { name: 'Legend: Tenacity', icon: 'perk-images/Styles/Precision/LegendTenacity/LegendTenacity.png' },
            9103: { name: 'Legend: Bloodline', icon: 'perk-images/Styles/Precision/LegendBloodline/LegendBloodline.png' },
            8014: { name: 'Coup de Grace', icon: 'perk-images/Styles/Precision/CoupDeGrace/CoupDeGrace.png' },
            8017: { name: 'Cut Down', icon: 'perk-images/Styles/Precision/CutDown/CutDown.png' },
            8299: { name: 'Last Stand', icon: 'perk-images/Styles/Sorcery/LastStand/LastStand.png' },
            // Domination
            8112: { name: 'Electrocute', icon: 'perk-images/Styles/Domination/Electrocute/Electrocute.png' },
            8124: { name: 'Predator', icon: 'perk-images/Styles/Domination/Predator/Predator.png' },
            8128: { name: 'Dark Harvest', icon: 'perk-images/Styles/Domination/DarkHarvest/DarkHarvest.png' },
            9923: { name: 'Hail of Blades', icon: 'perk-images/Styles/Domination/HailOfBlades/HailOfBlades.png' },
            8126: { name: 'Cheap Shot', icon: 'perk-images/Styles/Domination/CheapShot/CheapShot.png' },
            8139: { name: 'Taste of Blood', icon: 'perk-images/Styles/Domination/TasteOfBlood/GreenTerror_TasteOfBlood.png' },
            8143: { name: 'Sudden Impact', icon: 'perk-images/Styles/Domination/SuddenImpact/SuddenImpact.png' },
            8136: { name: 'Zombie Ward', icon: 'perk-images/Styles/Domination/ZombieWard/ZombieWard.png' },
            8120: { name: 'Ghost Poro', icon: 'perk-images/Styles/Domination/GhostPoro/GhostPoro.png' },
            8138: { name: 'Eyeball Collection', icon: 'perk-images/Styles/Domination/EyeballCollection/EyeballCollection.png' },
            8135: { name: 'Treasure Hunter', icon: 'perk-images/Styles/Domination/TreasureHunter/TreasureHunter.png' },
            8134: { name: 'Ingenious Hunter', icon: 'perk-images/Styles/Domination/IngeniousHunter/IngeniousHunter.png' },
            8105: { name: 'Relentless Hunter', icon: 'perk-images/Styles/Domination/RelentlessHunter/RelentlessHunter.png' },
            8106: { name: 'Ultimate Hunter', icon: 'perk-images/Styles/Domination/UltimateHunter/UltimateHunter.png' },
            // Sorcery
            8214: { name: 'Summon Aery', icon: 'perk-images/Styles/Sorcery/SummonAery/SummonAery.png' },
            8229: { name: 'Arcane Comet', icon: 'perk-images/Styles/Sorcery/ArcaneComet/ArcaneComet.png' },
            8230: { name: 'Phase Rush', icon: 'perk-images/Styles/Sorcery/PhaseRush/PhaseRush.png' },
            8224: { name: 'Nullifying Orb', icon: 'perk-images/Styles/Sorcery/NullifyingOrb/Pokeshield.png' },
            8226: { name: 'Manaflow Band', icon: 'perk-images/Styles/Sorcery/ManaflowBand/ManaflowBand.png' },
            8275: { name: 'Nimbus Cloak', icon: 'perk-images/Styles/Sorcery/NimbusCloak/6361.png' },
            8210: { name: 'Transcendence', icon: 'perk-images/Styles/Sorcery/Transcendence/Transcendence.png' },
            8234: { name: 'Celerity', icon: 'perk-images/Styles/Sorcery/Celerity/CelerityTemp.png' },
            8233: { name: 'Absolute Focus', icon: 'perk-images/Styles/Sorcery/AbsoluteFocus/AbsoluteFocus.png' },
            8237: { name: 'Scorch', icon: 'perk-images/Styles/Sorcery/Scorch/Scorch.png' },
            8232: { name: 'Waterwalking', icon: 'perk-images/Styles/Sorcery/Waterwalking/Waterwalking.png' },
            8236: { name: 'Gathering Storm', icon: 'perk-images/Styles/Sorcery/GatheringStorm/GatheringStorm.png' },
            // Resolve
            8437: { name: 'Grasp of the Undying', icon: 'perk-images/Styles/Resolve/GraspOfTheUndying/GraspOfTheUndying.png' },
            8439: { name: 'Aftershock', icon: 'perk-images/Styles/Resolve/VeteranAftershock/VeteranAftershock.png' },
            8465: { name: 'Guardian', icon: 'perk-images/Styles/Resolve/Guardian/Guardian.png' },
            8446: { name: 'Demolish', icon: 'perk-images/Styles/Resolve/Demolish/Demolish.png' },
            8463: { name: 'Font of Life', icon: 'perk-images/Styles/Resolve/FontOfLife/FontOfLife.png' },
            8401: { name: 'Shield Bash', icon: 'perk-images/Styles/Resolve/MirrorShell/MirrorShell.png' },
            8429: { name: 'Conditioning', icon: 'perk-images/Styles/Resolve/Conditioning/Conditioning.png' },
            8444: { name: 'Second Wind', icon: 'perk-images/Styles/Resolve/SecondWind/SecondWind.png' },
            8473: { name: 'Bone Plating', icon: 'perk-images/Styles/Resolve/BonePlating/BonePlating.png' },
            8451: { name: 'Overgrowth', icon: 'perk-images/Styles/Resolve/Overgrowth/Overgrowth.png' },
            8453: { name: 'Revitalize', icon: 'perk-images/Styles/Resolve/Revitalize/Revitalize.png' },
            8242: { name: 'Unflinching', icon: 'perk-images/Styles/Sorcery/Unflinching/Unflinching.png' },
            // Inspiration
            8351: { name: 'Glacial Augment', icon: 'perk-images/Styles/Inspiration/GlacialAugment/GlacialAugment.png' },
            8360: { name: 'Unsealed Spellbook', icon: 'perk-images/Styles/Inspiration/UnsealedSpellbook/UnsealedSpellbook.png' },
            8369: { name: 'First Strike', icon: 'perk-images/Styles/Inspiration/FirstStrike/FirstStrike.png' },
            8306: { name: 'Hextech Flashtraption', icon: 'perk-images/Styles/Inspiration/HextechFlashtraption/HextechFlashtraption.png' },
            8304: { name: 'Magical Footwear', icon: 'perk-images/Styles/Inspiration/MagicalFootwear/MagicalFootwear.png' },
            8313: { name: 'Triple Tonic', icon: 'perk-images/Styles/Inspiration/PerfectTiming/PerfectTiming.png' },
            8321: { name: 'Future\'s Market', icon: 'perk-images/Styles/Inspiration/FuturesMarket/FuturesMarket.png' },
            8316: { name: 'Minion Dematerializer', icon: 'perk-images/Styles/Inspiration/MinionDematerializer/MinionDematerializer.png' },
            8345: { name: 'Biscuit Delivery', icon: 'perk-images/Styles/Inspiration/BiscuitDelivery/BiscuitDelivery.png' },
            8347: { name: 'Cosmic Insight', icon: 'perk-images/Styles/Inspiration/CosmicInsight/CosmicInsight.png' },
            8410: { name: 'Approach Velocity', icon: 'perk-images/Styles/Resolve/ApproachVelocity/ApproachVelocity.png' },
            8352: { name: 'Time Warp Tonic', icon: 'perk-images/Styles/Inspiration/TimeWarpTonic/TimeWarpTonic.png' },
            // Jack of All Trades
            8135: { name: 'Treasure Hunter', icon: 'perk-images/Styles/Domination/TreasureHunter/TreasureHunter.png' }
        };

        // Stat shards
        const STAT_SHARDS = {
            5008: { name: 'Adaptive Force', icon: 'perk-images/StatMods/StatModsAdaptiveForceIcon.png' },
            5005: { name: 'Attack Speed', icon: 'perk-images/StatMods/StatModsAttackSpeedIcon.png' },
            5007: { name: 'Ability Haste', icon: 'perk-images/StatMods/StatModsCDRScalingIcon.png' },
            5002: { name: 'Armor', icon: 'perk-images/StatMods/StatModsArmorIcon.png' },
            5003: { name: 'Magic Resist', icon: 'perk-images/StatMods/StatModsMagicResIcon.png' },
            5001: { name: 'Health', icon: 'perk-images/StatMods/StatModsHealthScalingIcon.png' },
            5010: { name: 'Move Speed', icon: 'perk-images/StatMods/StatModsMovementSpeedIcon.png' }
        };

        function getRuneIcon(runeId) {
            const tree = RUNE_TREES[runeId];
            if (tree) return `${DDRAGON_BASE}/img/${tree.icon}`;
            const rune = RUNES[runeId];
            if (rune) return `${DDRAGON_BASE}/img/${rune.icon}`;
            return null;
        }

        function getRuneName(runeId) {
            const tree = RUNE_TREES[runeId];
            if (tree) return tree.name;
            const rune = RUNES[runeId];
            if (rune) return rune.name;
            return 'Unknown';
        }

        function showRunePopup(runesData, event) {
            event.stopPropagation();
            if (!runesData) return;

            const popup = document.getElementById('runePopup');
            const content = document.getElementById('runePopupContent');

            let html = '';

            // Primary tree
            if (runesData.primary && runesData.primary.style) {
                const primaryTree = RUNE_TREES[runesData.primary.style];
                html += `<div class="rune-tree">
                    <div class="rune-tree-header">
                        <img src="${getRuneIcon(runesData.primary.style)}" class="rune-tree-icon" onerror="this.style.display='none'">
                        <span class="rune-tree-name">${primaryTree?.name || 'Primary'}</span>
                    </div>
                    <div class="rune-perks">`;

                runesData.primary.perks.slice(0, 4).forEach((perkId, idx) => {
                    const rune = RUNES[perkId];
                    const isKeystone = idx === 0;
                    html += `<div class="rune-perk ${isKeystone ? 'keystone' : ''}">
                        <img src="${getRuneIcon(perkId)}" class="rune-perk-icon" onerror="this.style.display='none'">
                        <span class="rune-perk-name">${rune?.name || 'Unknown'}</span>
                    </div>`;
                });

                html += `</div></div>`;
            }

            // Secondary tree
            if (runesData.secondary && runesData.secondary.style) {
                const secondaryTree = RUNE_TREES[runesData.secondary.style];
                html += `<div class="rune-tree secondary">
                    <div class="rune-tree-header">
                        <img src="${getRuneIcon(runesData.secondary.style)}" class="rune-tree-icon" onerror="this.style.display='none'">
                        <span class="rune-tree-name">${secondaryTree?.name || 'Secondary'}</span>
                    </div>
                    <div class="rune-perks">`;

                runesData.secondary.perks.slice(0, 2).forEach(perkId => {
                    const rune = RUNES[perkId];
                    html += `<div class="rune-perk">
                        <img src="${getRuneIcon(perkId)}" class="rune-perk-icon" onerror="this.style.display='none'">
                        <span class="rune-perk-name">${rune?.name || 'Unknown'}</span>
                    </div>`;
                });

                html += `</div></div>`;
            }

            // Stat shards
            if (runesData.statPerks) {
                html += `<div class="rune-stat-shards">`;
                ['offense', 'flex', 'defense'].forEach(type => {
                    const shardId = runesData.statPerks[type];
                    const shard = STAT_SHARDS[shardId];
                    if (shard) {
                        html += `<div class="rune-stat-shard">
                            <img src="${DDRAGON_BASE}/img/${shard.icon}" class="rune-stat-icon" onerror="this.style.display='none'">
                            <span class="rune-stat-name">${shard.name}</span>
                        </div>`;
                    }
                });
                html += `</div>`;
            }

            content.innerHTML = html;
            popup.classList.add('show');
        }

        function closeRunePopup(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('runePopup').classList.remove('show');
        }

        function formatGold(gold) {
            if (gold >= 1000) return (gold / 1000).toFixed(1) + 'k';
            return gold;
        }

        function formatDamage(dmg) {
            if (dmg >= 1000) return (dmg / 1000).toFixed(1) + 'k';
            return dmg;
        }

        function toggleMatchDetails(matchId) {
            const matchEl = document.getElementById(`match-${matchId}`);
            if (matchEl) {
                matchEl.classList.toggle('expanded');
            }
        }

        function lookupPlayer(name, tag, region) {
            document.getElementById('gameName').value = name;
            document.getElementById('tagLine').value = tag;
            document.getElementById('region').value = region;
            lookup(false);
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp * 1000);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)} min ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)} hours ago`;
            return date.toLocaleDateString();
        }

        function getShareUrl(gameName, tagLine, region) {
            return `${window.location.origin}/player/${encodeURIComponent(gameName)}/${encodeURIComponent(tagLine)}/${region}`;
        }

        function formatMatchTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            if (diff < 604800) return `${Math.floor(diff / 86400)}d ago`;
            return date.toLocaleDateString();
        }

        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function renderMatchHistory(matches, version, limit, currentRegion) {
            const displayMatches = matches.slice(0, limit);
            let html = '';
            matchRunesData = [];

            displayMatches.forEach((match, index) => {
                const resultClass = match.win ? 'win' : 'loss';
                const resultText = match.win ? 'Victory' : 'Defeat';
                const champIconUrl = getChampionIcon(match.championId, version);
                const kda = match.deaths === 0 ? 'Perfect' : ((match.kills + match.assists) / match.deaths).toFixed(2);
                const matchIndex = index;

                // Items HTML
                let itemsHtml = '';
                if (match.items) {
                    match.items.forEach(itemId => {
                        const itemUrl = getItemIcon(itemId, version);
                        if (itemUrl) {
                            itemsHtml += `<img src="${itemUrl}" class="match-item-icon" onerror="this.style.visibility='hidden'">`;
                        } else {
                            itemsHtml += `<div class="match-item-icon"></div>`;
                        }
                    });
                }

                // Runes HTML - store runes data for popup
                matchRunesData[matchIndex] = match.runes;
                const fallbackIcon = 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 32 32%22><circle cx=%2216%22 cy=%2216%22 r=%2214%22 fill=%22%23333%22 stroke=%22%23555%22/></svg>';
                const primaryRuneUrl = getRuneIcon(match.primaryRune) || fallbackIcon;
                const secondaryRuneUrl = getRuneIcon(match.secondaryRune) || fallbackIcon;
                let runesHtml = `<img src="${primaryRuneUrl}" class="match-rune-icon" onerror="this.src='${fallbackIcon}'">`;
                runesHtml += `<img src="${secondaryRuneUrl}" class="match-rune-icon" onerror="this.src='${fallbackIcon}'">`;

                // Teams HTML
                let teamsHtml = '';
                if (match.participants) {
                    const blueTeam = match.participants.filter(p => p.teamId === 100);
                    const redTeam = match.participants.filter(p => p.teamId === 200);

                    const renderTeam = (team, teamName, teamClass) => {
                        let teamHtml = `<div class="match-team ${teamClass}">`;
                        teamHtml += `<div class="match-team-header">
                            <span>${teamName} ${team[0]?.win ? '(Victory)' : '(Defeat)'}</span>
                            <div class="team-header-stats">
                                <span class="header-dmg" title="Damage">DMG</span>
                                <span class="header-gold" title="Gold">GOLD</span>
                            </div>
                        </div>`;

                        team.forEach(p => {
                            const pChampIcon = getChampionIcon(p.championId, version);
                            const isCurrentPlayer = p.puuid === currentPlayerData?.puuid;
                            const playerClass = isCurrentPlayer ? 'match-participant current-player' : 'match-participant';

                            let pItemsHtml = '';
                            if (p.items) {
                                p.items.slice(0, 6).forEach(itemId => {
                                    const itemUrl = getItemIcon(itemId, version);
                                    if (itemUrl) {
                                        pItemsHtml += `<img src="${itemUrl}" class="participant-item-icon" onerror="this.style.visibility='hidden'">`;
                                    } else {
                                        pItemsHtml += `<div class="participant-item-icon"></div>`;
                                    }
                                });
                            }

                            teamHtml += `
                                <div class="${playerClass}">
                                    <img src="${pChampIcon}" class="participant-champ-icon" onerror="this.style.display='none'">
                                    <div class="participant-info">
                                        <div class="participant-name" onclick="lookupPlayer('${p.summonerName}', '${p.tagLine}', '${currentRegion}')">${p.summonerName}</div>
                                        <div class="participant-kda">${p.kills}/${p.deaths}/${p.assists}</div>
                                    </div>
                                    <div class="participant-items">${pItemsHtml}</div>
                                    <div class="participant-damage">${formatDamage(p.damage)}</div>
                                    <div class="participant-gold">${formatGold(p.gold)}</div>
                                </div>
                            `;
                        });
                        teamHtml += '</div>';
                        return teamHtml;
                    };

                    teamsHtml = `<div class="match-teams">
                        ${renderTeam(blueTeam, 'Blue Team', 'blue-team')}
                        ${renderTeam(redTeam, 'Red Team', 'red-team')}
                    </div>`;
                }

                html += `
                    <div class="match-item ${resultClass}" id="match-${matchIndex}" onclick="toggleMatchDetails(${matchIndex})">
                        <div class="match-header">
                            <img src="${champIconUrl}" alt="${match.champion}" class="match-champion-icon" onerror="this.style.display='none'">
                            <div class="match-info">
                                <div class="match-top-row">
                                    <span class="match-result">${resultText}</span>
                                    <span class="match-champion-name">${match.champion}</span>
                                </div>
                                <div class="match-bottom-row">
                                    <span class="match-kda">
                                        <span class="kills">${match.kills}</span> /
                                        <span class="deaths">${match.deaths}</span> /
                                        <span class="assists">${match.assists}</span>
                                        <span style="color: #666; margin-left: 5px;">(${kda} KDA)</span>
                                    </span>
                                    <span class="match-cs">${match.cs} CS</span>
                                </div>
                            </div>
                            <div class="match-stats">
                                <span class="match-duration">${formatDuration(match.duration)}</span>
                                <span class="match-time">${formatMatchTime(match.timestamp)}</span>
                            </div>
                            <span class="match-expand-icon">▼</span>
                        </div>
                        <div class="match-details" onclick="event.stopPropagation()">
                            <div class="match-player-stats">
                                <div class="match-stat-box">
                                    <div class="match-stat-label">Damage</div>
                                    <div class="match-stat-value" style="color: #d9534f;">${formatDamage(match.damage || 0)}</div>
                                </div>
                                <div class="match-stat-box">
                                    <div class="match-stat-label">Gold</div>
                                    <div class="match-stat-value" style="color: #c89b3c;">${formatGold(match.gold || 0)}</div>
                                </div>
                                <div class="match-stat-box">
                                    <div class="match-stat-label">CS</div>
                                    <div class="match-stat-value">${match.cs}</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 15px; align-items: flex-start; margin-bottom: 15px; flex-wrap: wrap;">
                                <div class="match-items-row">${itemsHtml}</div>
                                <div class="match-runes" onclick="showRunePopup(matchRunesData[${matchIndex}], event)" title="Click to view runes">${runesHtml}</div>
                            </div>
                            ${teamsHtml}
                        </div>
                    </div>
                `;
            });

            return html;
        }

        function loadMoreMatches() {
            if (!currentPlayerData || !currentPlayerData.match_history) return;

            matchesDisplayed += 5;
            const version = currentPlayerData.ddragon_version || '14.24.1';
            const currentRegion = currentPlayerData.region || document.getElementById('region').value;
            const matchListDiv = document.getElementById('matchList');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const totalMatches = currentPlayerData.match_history.length;

            matchListDiv.innerHTML = renderMatchHistory(currentPlayerData.match_history, version, matchesDisplayed, currentRegion);

            if (matchesDisplayed >= totalMatches) {
                loadMoreBtn.style.display = 'none';
            } else {
                const remaining = totalMatches - matchesDisplayed;
                loadMoreBtn.textContent = `Load more (${remaining} remaining)`;
            }
        }

        function copyToClipboard(text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'Copy';
                    btn.classList.remove('copied');
                }, 2000);
            });
        }

        async function lookup(forceRefresh = false) {
            const gameName = document.getElementById('gameName').value.trim();
            const tagLine = document.getElementById('tagLine').value.trim();
            const region = document.getElementById('region').value;
            const resultsDiv = document.getElementById('results');
            const loadingDiv = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            const searchBtn = document.getElementById('searchBtn');

            if (!gameName || !tagLine) {
                resultsDiv.innerHTML = '<div class="error-msg">Please enter both Game Name and Tag</div>';
                resultsDiv.classList.add('show');
                return;
            }

            searchBtn.disabled = true;
            loadingDiv.style.display = 'block';
            loadingText.textContent = forceRefresh
                ? 'Refreshing data from Riot API...'
                : 'Fetching player data...';
            resultsDiv.classList.remove('show');

            try {
                const response = await fetch('/lookup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ gameName, tagLine, region, refresh: forceRefresh })
                });

                const data = await response.json();
                loadingDiv.style.display = 'none';
                searchBtn.disabled = false;

                if (!data.success) {
                    resultsDiv.innerHTML = `<div class="error-msg">${data.error}</div>`;
                    resultsDiv.classList.add('show');
                    return;
                }

                currentPlayerData = data;

                // Update URL without reload
                const newUrl = getShareUrl(data.gameName, data.tagLine, region);
                window.history.pushState({}, '', `/player/${encodeURIComponent(data.gameName)}/${encodeURIComponent(data.tagLine)}/${region}`);

                const version = data.ddragon_version || '14.24.1';
                const profileIconUrl = data.profileIcon ? getProfileIcon(data.profileIcon, version) : '';
                const shareUrl = getShareUrl(data.gameName, data.tagLine, region);
                const cacheStatus = data.from_cache
                    ? `<span class="cache-badge">Cached - ${formatTime(data.updated_at)}</span>`
                    : `<span class="cache-badge fresh">Fresh data</span>`;

                let html = `
                    <div class="player-header">
                        <div class="header-actions">
                            <button class="action-btn refresh-btn" onclick="lookup(true)" title="Refresh data from Riot API">
                                ↻ Refresh
                            </button>
                        </div>
                        ${profileIconUrl ? `<img src="${profileIconUrl}" alt="Profile Icon" class="profile-icon" onerror="this.style.display='none'">` : ''}
                        <div class="player-info">
                            <div class="player-name">${data.player}</div>
                            <div class="player-level">Level ${data.level || 'Unknown'}</div>
                            <div class="player-meta">
                                ${cacheStatus}
                            </div>
                            <div class="share-url-container">
                                <span class="share-url">${shareUrl}</span>
                                <button class="copy-btn" onclick="copyToClipboard('${shareUrl}', this)">Copy</button>
                            </div>
                        </div>
                    </div>
                    <div class="stats-grid">
                `;

                // Ranked stats
                html += '<div class="stat-card"><h3>Ranked Stats</h3>';
                if (data.ranked.length === 0) {
                    html += '<p class="unranked">Unranked this season</p>';
                } else {
                    data.ranked.forEach(r => {
                        const emblemUrl = getRankEmblem(r.tier);
                        html += `
                            <div class="rank-display">
                                <img src="${emblemUrl}" alt="${r.tier}" class="rank-emblem" onerror="this.style.display='none'">
                                <div class="rank-info">
                                    <div class="rank-queue">${r.queue}</div>
                                    <div class="rank-tier">${r.tier} ${r.rank}</div>
                                    <div class="rank-lp">${r.lp} LP</div>
                                    <div class="rank-record">
                                        <span class="win">${r.wins}W</span> /
                                        <span class="loss">${r.losses}L</span>
                                        (${r.winrate}% WR)
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                html += '</div>';

                // Top Champions
                html += '<div class="stat-card"><h3>Top Champions (min 3 games)</h3>';
                if (data.top_champions.length === 0) {
                    html += '<p class="unranked">Not enough games on any champion</p>';
                } else {
                    html += '<ul class="champion-list">';
                    data.top_champions.forEach((c, i) => {
                        const wrColor = c.winrate >= 50 ? '#4caf50' : '#f44336';
                        const champIconUrl = getChampionIcon(c.id, version);
                        html += `
                            <li class="champion-item">
                                <span class="rank-number">${i + 1}</span>
                                <img src="${champIconUrl}" alt="${c.name}" class="champion-icon" onerror="this.style.display='none'">
                                <div class="champion-details">
                                    <div class="champion-name">${c.name}</div>
                                    <div class="champion-games">${c.wins}W / ${c.losses}L (${c.games} games)</div>
                                </div>
                                <span class="champion-wr" style="color: ${wrColor}">${c.winrate}%</span>
                            </li>
                        `;
                    });
                    html += '</ul>';
                }
                html += '</div>';

                // Side Stats
                if (data.side_stats) {
                    html += '<div class="stat-card"><h3>Side Winrates</h3>';
                    const blue = data.side_stats.blue;
                    const red = data.side_stats.red;

                    const blueColor = blue.winrate >= 50 ? '#4caf50' : '#f44336';
                    const redColor = red.winrate >= 50 ? '#4caf50' : '#f44336';

                    html += `
                        <div class="side-row side-blue">
                            <span class="side-name">
                                Blue Side
                                ${blue.better ? '<span class="better-tag">BETTER</span>' : ''}
                            </span>
                            <span style="color: ${blueColor}; font-weight: bold;">${blue.winrate}%</span>
                            <span style="color: #888;">(${blue.wins}W/${blue.losses}L)</span>
                        </div>
                        <div class="side-row side-red">
                            <span class="side-name">
                                Red Side
                                ${red.better ? '<span class="better-tag">BETTER</span>' : ''}
                            </span>
                            <span style="color: ${redColor}; font-weight: bold;">${red.winrate}%</span>
                            <span style="color: #888;">(${red.wins}W/${red.losses}L)</span>
                        </div>
                    `;
                    html += '</div>';
                }

                // Season History
                html += '<div class="stat-card season-history-card"><h3>Season History</h3>';
                const seasonHistory = data.season_history || {};
                // Only exclude future seasons
                const excludeSeasons = new Set(['S2026', 'S16']);

                // Custom sort: S2025 > S14 S3 > S14 S1 > S13 > S12 > ... > S7
                function seasonSortKey(season) {
                    const match = season.match(/S(\d+)(?:\s*S(\d))?/);
                    if (match) {
                        const year = parseInt(match[1]);
                        const split = match[2] ? parseInt(match[2]) : 0;
                        return year * 10 + split;
                    }
                    return 0;
                }

                const seasons = Object.keys(seasonHistory)
                    .filter(s => !excludeSeasons.has(s))
                    .sort((a, b) => seasonSortKey(b) - seasonSortKey(a));

                if (seasons.length === 0) {
                    html += '<p class="unranked">No past season data</p>';
                } else {
                    html += '<div class="season-grid">';
                    seasons.forEach((season) => {
                        const seasonData = seasonHistory[season];
                        const soloData = seasonData.find(r => r.queue === 'Solo/Duo') || seasonData[0];

                        if (soloData && soloData.tier) {
                            const emblemUrl = getRankEmblem(soloData.tier);
                            const rankText = soloData.rank ? ` ${soloData.rank}` : '';
                            const lpText = soloData.lp > 0 ? ` (${soloData.lp} LP)` : '';

                            html += `
                                <div class="season-tile">
                                    <img src="${emblemUrl}" alt="${soloData.tier}" class="season-emblem-small" onerror="this.style.display='none'">
                                    <div class="season-tile-info">
                                        <span class="season-tile-name">${season}</span>
                                        <span class="season-tile-rank">${soloData.tier}${rankText}${lpText}</span>
                                    </div>
                                </div>
                            `;
                        }
                    });
                    html += '</div>';
                }

                html += '</div>';

                // Match History
                matchesDisplayed = 5;
                const matchHistory = data.match_history || [];
                html += '<div class="stat-card match-history-card"><h3>Match History</h3>';
                if (matchHistory.length === 0) {
                    html += '<p class="unranked">No recent ranked matches</p>';
                } else {
                    html += `<div class="match-list" id="matchList">${renderMatchHistory(matchHistory, version, matchesDisplayed, region)}</div>`;
                    if (matchHistory.length > matchesDisplayed) {
                        html += `<button class="load-more-btn" id="loadMoreBtn" onclick="loadMoreMatches()">Load more (${matchHistory.length - matchesDisplayed} remaining)</button>`;
                    }
                }
                html += '</div>';

                html += '</div>';
                resultsDiv.innerHTML = html;
                resultsDiv.classList.add('show');

            } catch (error) {
                loadingDiv.style.display = 'none';
                searchBtn.disabled = false;
                resultsDiv.innerHTML = '<div class="error-msg">An error occurred. Please try again.</div>';
                resultsDiv.classList.add('show');
            }
        }

        // Enter key to search
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') lookup(false);
        });

        // Auto-search if coming from a player URL
        {% if auto_search %}
        window.addEventListener('load', () => lookup(false));
        {% endif %}
    </script>
</body>
</html>
